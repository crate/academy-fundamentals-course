<p>This exercise requires a CrateDB cluster with the course dataset loaded.&nbsp; If you didn't create your cluster earlier in the course, complete <a href="/cratedb-fundamentals?lesson=handson-your-first-cratedb-cluster" rel="noopener" target="_blank">these steps</a> before going further.</p>
<hr>
<h2>Try Some of the Queries from the Video</h2>
<p>Let’s try a query that finds the most recent ride start time for each Kia Soul taxi:</p>
<pre>SELECT t.vehicleid, make, model, max(r.starttime) AS ride_start <br>FROM taxis t JOIN taxi_rides r ON t.vehicleid = r.vehicleid <br>WHERE make='KIA' AND model='SOUL' <br>GROUP BY t.vehicleid, make, model <br>ORDER BY ride_start DESC;</pre>
<p>As all 8 of the Kia Souls completed at least one taxi ride, data is returned for each.</p>
<p>Now, run this query which returns details of how many rides each Kia Soul taxi undertook that originated in the O’Hare area and ended in The Loop:</p>
<pre>SELECT t.vehicleid, make, model, count(r.vehicleid) AS num_trips FROM taxis t <br>JOIN taxi_rides r ON t.vehicleid = r.vehicleid AND pickupcommunityarea = 76 AND dropoffcommunityarea = 32 <br>WHERE t.make='KIA' AND t.model='SOUL' <br>GROUP BY t.vehicleid, make, model <br>ORDER BY num_trips DESC;</pre>
<p>How many rows does this return? Why are there fewer than 8 rows?</p>
<p>Finally, run this left outer join query which also returns details of the number of rides undertaken by each Kia Soul taxi from the O’Hare area to The Loop.</p>
<pre>SELECT t.vehicleid, make, model, count(r.vehicleid) AS num_trips FROM taxis t <br>LEFT JOIN taxi_rides r ON t.vehicleid = r.vehicleid AND pickupcommunityarea=76 AND dropoffcommunityarea=32 <br>WHERE t.make='KIA' AND t.model='SOUL' <br>GROUP BY t.vehicleid, make, model <br>ORDER BY num_trips DESC;</pre>
<p>Why does this query return 8 rows?</p>
<h2>Try Some Joins of Your Own</h2>
<p>Take a moment to try out some queries of your own that use joins. Our examples used the <span style="font-family: terminal, monospace;">taxis </span>and <span style="font-family: terminal, monospace;">taxi_rides </span>tables, but you could also use the following pairs of tables:</p>
<ul>
<li><span style="font-family: terminal, monospace;">community_areas</span> (<span style="font-family: terminal, monospace;">areanumber</span>) joined on <span style="font-family: terminal, monospace;">three_eleven_calls</span> (<span style="font-family: terminal, monospace;">locationdetails['communityarea']</span>).</li>
<li><span style="font-family: terminal, monospace;">libraries</span> (<span style="font-family: terminal, monospace;">location['communityarea']</span>) joined on <span style="font-family: terminal, monospace;">community_areas</span> (<span style="font-family: terminal, monospace;">areanumber</span>).</li>
</ul>
<p>Refer to the <a href="https://cratedb.com/docs/crate/reference/en/latest/general/dql/joins.html">joins documentation</a> for more information on SQL syntax and available options.</p>
<p>Check if your CrateDB cluster has these tables using a count query:</p>
<pre><span style="font-family: terminal, monospace;">SELECT count(*) FROM table_name;</span></pre>
<p>Replacing <span style="font-family: terminal, monospace;">table_name</span> with <span style="font-family: terminal, monospace;">community_areas</span>, <span style="font-family: terminal, monospace;">three_eleven_calls</span> and libraries as needed.</p>
<p>If one or more of the queries error, create and populate the table using the SQL statements below.</p>
<h3>Community Areas Table</h3>
<div>
<pre><span>DROP</span><span> </span><span>TABLE</span><span> </span><span>IF</span><span> </span><span>EXISTS</span><span> community_areas;</span><br><br><span>CREATE</span><span> </span><span>TABLE</span><span> </span><span>community_areas</span><span> (</span><br><span>   areanumber </span><span>INTEGER</span><span> </span><span>PRIMARY KEY</span><span>,</span><br><span>   </span><span>name</span><span> </span><span>TEXT</span><span>,</span><br><span>   details </span><span>OBJECT</span><span>(STRICT) </span><span>AS</span><span> (</span><br><span>       </span><span>description</span><span> </span><span>TEXT</span><span> </span><span>INDEX</span><span> </span><span>USING</span><span> </span><span>fulltext</span><span> </span><span>WITH</span><span> (analyzer</span><span>=</span><span>'english'</span><span>),</span><br><span>       </span><span>population</span><span> </span><span>BIGINT</span><br><span>   ),</span><br><span>   boundaries GEO_SHAPE </span><span>INDEX</span><span> </span><span>USING</span><span> geohash </span><span>WITH</span><span> (</span><span>PRECISION</span><span>=</span><span>'1m'</span><span>, DISTANCE_ERROR_PCT</span><span>=</span><span>0</span><span>.</span><span>025</span><span>)</span><br><span>);<br><br>COPY community_areas <br>FROM '</span>https://github.com/crate/cratedb-datasets/raw/main/academy/chicago-data/chicago_community_areas.json<span>' <br>RETURN SUMMARY;</span></pre>
</div>
<h3>Libraries Table</h3>
<pre>DROP TABLE IF EXISTS libraries;<br><br>CREATE TABLE libraries (<br>&nbsp;&nbsp; name TEXT,<br>&nbsp;&nbsp; location OBJECT(DYNAMIC) AS (<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; address TEXT,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; zipcode TEXT,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; communityarea INTEGER,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; position GEO_POINT<br>&nbsp;&nbsp; ),<br>&nbsp;&nbsp; phone TEXT,<br>&nbsp;&nbsp; website TEXT<br>);<br><br>COPY libraries FROM 'https://github.com/crate/cratedb-datasets/raw/main/academy/chicago-data/chicago_libraries.json' RETURN SUMMARY;</pre>
<h3>311 Calls Table</h3>
<pre>DROP TABLE IF EXISTS three_eleven_calls;<br><br>CREATE TABLE three_eleven_calls (<br>&nbsp;&nbsp; srnumber TEXT,<br>&nbsp;&nbsp; srtype TEXT,<br>&nbsp;&nbsp; srshortcode TEXT,<br>&nbsp;&nbsp; createddept TEXT,<br>&nbsp;&nbsp; ownerdept TEXT,<br>&nbsp;&nbsp; status TEXT,<br>&nbsp;&nbsp; origin TEXT,<br>&nbsp;&nbsp; createddate TIMESTAMP,<br>&nbsp;&nbsp; lastmodifieddate TIMESTAMP,<br>&nbsp;&nbsp; closeddate TIMESTAMP,<br>&nbsp;&nbsp; week GENERATED ALWAYS AS date_trunc('week', createddate),<br>&nbsp;&nbsp; isduplicate BOOLEAN,<br>&nbsp;&nbsp; createdhour SMALLINT,<br>&nbsp;&nbsp; createddayofweek SMALLINT,<br>&nbsp;&nbsp; createdmonth SMALLINT,<br>&nbsp;&nbsp; locationdetails OBJECT(DYNAMIC) AS (<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; streetaddress TEXT,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; city TEXT,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; state TEXT,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; zipcode TEXT,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; streetnumber TEXT,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; streetdirection TEXT,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; streetname TEXT,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; streettype TEXT,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; communityarea SMALLINT,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ward SMALLINT,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; policesector SMALLINT,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; policedistrict SMALLINT,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; policebeat SMALLINT,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; precinct SMALLINT,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; latitude DOUBLE PRECISION,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; longitude DOUBLE PRECISION,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; location GEO_POINT<br>&nbsp;&nbsp; )<br>) PARTITIONED BY (week);<br><br>COPY three_eleven_calls <br>FROM 'https://github.com/crate/cratedb-datasets/raw/main/academy/chicago-data/311_records_apr_2024.json.gz' <br>WITH (compression='gzip') <br>RETURN SUMMARY;</pre>
<p>&nbsp;</p>